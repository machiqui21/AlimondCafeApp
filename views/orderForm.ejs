<div class="order-now-form">
    
        <div style="display: flex; flex-direction: row; gap: 32px;">
            <div style="flex: 1;">
                <h2>Order Now</h2>
                <form id="orderForm" action="/order" method="POST">
            <label for="customerName">Customer Name:</label>
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; width: 500px;">
                <input type="text" id="customerName" name="customerName" required style="flex:1; width:120px;">
            </div>
            <label for="product">Select Product:</label>
            <select id="product" name="product" required>
                <option value="" selected>None</option>
                <% if (ProductData && ProductData.length > 0) { %>
                    <% ProductData.forEach(function(product) { %>
                        <option value="<%= product.Name %>"><%= product.Name %></option>
                    <% }); %>
                <% } %>
            </select>
            <br><br>
            <label for="size">Select Size <span class="size-legend-wrapper inline"><img class="size-legend inline" src="/images/size-legend.jpg" alt="S M L" title="Small / Medium / Large"><span class="size-legend-text">S M L</span></span></label>
            <select id="size" name="size" required class="size-select">
                <option value="" selected>None</option>
                <% 
                    // order sizes Small -> Medium -> Large when possible
                    var orderedSizes = (PriceData || []).slice();
                    var orderKeys = ['small','medium','large'];
                    orderedSizes.sort(function(a,b){
                        var ka = (a.Item||a.size||a.Size||'').toString().trim().toLowerCase();
                        var kb = (b.Item||b.size||b.Size||'').toString().trim().toLowerCase();
                        function key(label){ if(!label) return orderKeys.length; if (label.indexOf('small')!==-1) return 0; if (label.indexOf('medium')!==-1) return 1; if (label.indexOf('large')!==-1) return 2; return orderKeys.length; }
                        return key(ka) - key(kb);
                    });
                %>
                <% if (orderedSizes && orderedSizes.length > 0) { %>
                    <% orderedSizes.forEach(function(price) { %>
                        <option value="<%= price.Item %>"><%= price.Item %></option>
                    <% }); %>
                <% } else { %>
                    <option value="">No sizes available</option>
                <% } %>
            </select>
            <br><br>
            <label>Extras:</label><br>
            <% if (ExtraPriceData && ExtraPriceData.length > 0) { %>
                <% ExtraPriceData.forEach(function(extra, idx) { %>
                    <input type="checkbox" id="extra_<%= idx %>" name="extras" value="<%= extra.Item %>" data-description="<%= (extra.description||extra.Description||'') %>">
                    <label for="extra_<%= idx %>">
                        <%= extra.Item %> <%= (typeof extra.price !== 'undefined' ? '(‚Ç±' + parseFloat(extra.price).toFixed(2) + ')' : '') %>
                    </label><br>
                <% }); %>
                <div id="extrasDescriptions"></div>
            <% } else { %>
                <span>No extras available</span><br>
            <% } %>
            <br>
            <% var sugarOpts = (typeof CustomPriceData !== 'undefined' ? CustomPriceData : []).filter(function(c){ return (c.type||'').toString().toLowerCase()==='Sweetener'; }); %>
            <% if (sugarOpts && sugarOpts.length > 0) { %>
                <label for="sugar">Sugar Level:</label>
                <select id="sugar" name="sugar">
                    <option value="">-- None --</option>
                    <% sugarOpts.forEach(function(s) { %>
                        <option value="<%= s.option %>" data-price="<%= parseFloat(s.price||0) %>" data-description="<%= (s.description||'') %>"><%= (s.option||s.Item||s.name) %> (‚Ç±<%= parseFloat(s.price||0).toFixed(2) %>)</option>
                    <% }); %>
                </select>
                <div id="sugarDescription"></div>
            <% } else { %>
                <label for="sugar">Sugar Level:</label>
                <select id="sugar" name="sugar">
                    <option value="">-- None --</option>
                </select>
            <% } %>

            <% var milkOpts = (typeof CustomPriceData !== 'undefined' ? CustomPriceData : []).filter(function(c){ return (c.type||'').toString().toLowerCase()==='milk'; }); %>
            <% if (milkOpts && milkOpts.length > 0) { %>
                <br>
                <label for="customOption">Milk:</label>
                <select id="customOption" name="customOption">
                    <option value="">None</option>
                    <% milkOpts.forEach(function(m){ %>
                        <option value="<%= m.option %>" data-price="<%= parseFloat(m.price||0) %>" data-description="<%= (m.description||'') %>"><%= (m.option||m.Item||m.name) %> (‚Ç±<%= parseFloat(m.price||0).toFixed(2) %>)</option>
                    <% }); %>
                </select>
                <div id="customOptionDescription"></div>
            <% } %>
            <br>
            <label for="qty">Qty:</label>
            <input type="number" id="qty" name="qty" min="1" max="10" value="1" style="width:60px;">
            <br>
            <br>
            <div id="priceDisplay" style="font-weight:bold;">Order Amount: ‚Ç±<span id="orderPrice">0.00</span></div>
            <br>
            <button type="submit" class="btn">Submit order</button>
        </form>
    </div>
    <script>
        var priceList = <%- JSON.stringify(PriceData || []) %>;
        var extraList = <%- JSON.stringify(ExtraPriceData || []) %>;
        var customList = <%- JSON.stringify(CustomPriceData || []) %>;
        function getPrice(product, size) {
            if (!size) return 0;
            const want = size.toString().trim().toLowerCase();
            const found = priceList.find(p => {
                const label = (p.Item || p.size || p.Size || '').toString().trim().toLowerCase();
                return label === want;
            });
            if (!found) return 0;
            return parseFloat(found.Amount || found.Price || found.price || found.amount || 0);
        }
        function getExtraPrice(extra) {
            const found = extraList.find(e => (e.Item && e.Item === extra) || (e.option && e.option === extra));
            return found ? parseFloat(found.price || found.Amount || found.Price || 0) : 0;
        }
        function getCustomPrice(option) {
            const found = customList.find(c => (c.option && c.option === option) || (c.Item && c.Item === option));
            return found ? parseFloat(found.price || found.Price || 0) : 0;
        }
        function updateOrderPrice() {
            const product = document.getElementById('product').value;
            const size = document.getElementById('size').value;
            const qty = parseInt(document.getElementById('qty').value, 10) || 1;
            let price = 0;
            if (product && size) {
                price = getPrice(product, size);
                // Sum all checked extras (checkboxes)
                const extraCheckboxes = document.querySelectorAll('input[type="checkbox"][name="extras"]:checked');
                extraCheckboxes.forEach(function (cb) {
                    price += getExtraPrice(cb.value);
                });
                // add custom selection like milk
                var customSel = document.getElementById('customOption');
                if (customSel && customSel.selectedOptions.length && customSel.selectedOptions[0].value) {
                    price += getCustomPrice(customSel.selectedOptions[0].value);
                }
            }
            const total = price * qty;
            document.getElementById('orderPrice').textContent = total.toFixed(2);
            // update description boxes
            try {
                var sugarSel = document.getElementById('sugar');
                var sugarDescEl = document.getElementById('sugarDescription');
                if (sugarDescEl) {
                    if (sugarSel && sugarSel.selectedOptions.length) {
                        sugarDescEl.textContent = sugarSel.selectedOptions[0].dataset.description || '';
                        sugarDescEl.style.display = sugarDescEl.textContent ? 'block' : 'none';
                    } else { sugarDescEl.textContent = ''; sugarDescEl.style.display = 'none'; }
                }
                var customSel = document.getElementById('customOption');
                var customDescEl = document.getElementById('customOptionDescription');
                if (customDescEl) {
                    if (customSel && customSel.selectedOptions.length) {
                        customDescEl.textContent = customSel.selectedOptions[0].dataset.description || '';
                        customDescEl.style.display = customDescEl.textContent ? 'block' : 'none';
                    } else { customDescEl.textContent = ''; customDescEl.style.display = 'none'; }
                }
                // extras: list descriptions of checked extras
                var extrasDesc = document.getElementById('extrasDescriptions');
                if (extrasDesc) {
                    var checked = Array.from(document.querySelectorAll('input[type="checkbox"][name="extras"]:checked'));
                    if (checked.length) {
                        extrasDesc.innerHTML = checked.map(function(cb){ var d = cb.dataset.description || ''; return d ? ('<div>' + (cb.value || '') + ': ' + d + '</div>') : ''; }).join('');
                        extrasDesc.style.display = extrasDesc.innerHTML ? 'block' : 'none';
                    } else { extrasDesc.innerHTML = ''; extrasDesc.style.display = 'none'; }
                }
            } catch (e) { /* non-fatal */ }
            return total;
        }
        document.addEventListener('DOMContentLoaded', function() {
            var productSelect = document.getElementById('product');
            if (productSelect) productSelect.addEventListener('change', updateOrderPrice);
            var sizeSelect = document.getElementById('size');
            if (sizeSelect) sizeSelect.addEventListener('change', updateOrderPrice);
            var qtyInput = document.getElementById('qty');
            if (qtyInput) qtyInput.addEventListener('input', updateOrderPrice);
            // Add event listeners to all extras checkboxes
            const extraCheckboxes = document.querySelectorAll('input[type="checkbox"][name="extras"]');
            extraCheckboxes.forEach(function(cb) {
                cb.addEventListener('change', updateOrderPrice);
            });
            var sugarSel = document.getElementById('sugar'); if (sugarSel) sugarSel.addEventListener('change', updateOrderPrice);
            var customSel = document.getElementById('customOption'); if (customSel) customSel.addEventListener('change', updateOrderPrice);
            // Set orderPrice to the return value of updateOrderPrice
            var orderPriceSpan = document.getElementById('orderPrice');
            if (orderPriceSpan) orderPriceSpan.textContent = updateOrderPrice().toFixed(2);
        });
        </script>

        <footer class="footer" style="margin-top: 32px;">
            <p>üìç Alimond's Caf√© ‚Äì Every cup brewed with love, for the neighborhood we call home.</p>
            <p>Follow us @alimondscafe | Open daily 9am‚Äì7pm</p>
        </footer>

        <div style="margin: 20px 0; padding: 0 20px; display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
            <button class="dark-mode-toggle" onclick="toggleDarkMode()" style="background: linear-gradient(135deg, #d4a574 0%, #c99860 100%); color: white; height: 48px; padding: 0 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease; display: inline-block; min-width: 150px; text-align: center; font-family: inherit; line-height: 48px;">üåô Toggle Dark Mode</button>
            <a href="/menu" class="btn" style="background: linear-gradient(135deg, #d4a574 0%, #c99860 100%); color: white; height: 48px; padding: 0 24px; text-decoration: none; border-radius: 8px; font-size: 1rem; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease; display: inline-block; min-width: 150px; text-align: center; font-family: inherit; line-height: 48px;">
                View Full Menu
            </a>
        </div>

        <script>
            function toggleDarkMode() {
                var isDark = document.body.classList.toggle('dark-mode');
                try { localStorage.setItem('darkMode', isDark ? '1' : '0'); } catch(e) {}
            }
            // Restore saved dark mode preference
            (function() {
                try {
                    var saved = localStorage.getItem('darkMode');
                    if (saved === '1') document.body.classList.add('dark-mode');
                } catch(e) {}
            })();
        </script>