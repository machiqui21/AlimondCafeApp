<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Order #<%= (header && (header.OrderID || header.ID)) %></title>
  <link rel="stylesheet" href="/menu.css">
</head>
<body>
  <header class="hero">
    <img class="logo" src="/images/AlimondsCafe.jpeg">
    <h1>Order #<%= (header && (header.OrderID || header.ID)) %></h1>
    <h3><%= header && header.StatusDescription ? header.StatusDescription : 'Pending' %></h3>
  </header>

  <main style="max-width: 900px; margin: 16px auto;">
    <section style="background:#fff; border-radius:8px; padding:12px 16px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
      <div style="display:flex; gap:16px; flex-wrap:wrap;">
        <div><strong>Customer:</strong> <%= header && header.CustomerName || '-' %></div>
        <div><strong>Date:</strong> <%= header && (header.CreatedAt || header.Created_at || header.created_at) %></div>
        <div><strong>Total:</strong> ‚Ç±<%= (parseFloat(header && header.TotalAmount || 0)||0).toFixed(2) %></div>
        <% if (header && header.PaymentMethod) { %>
          <div><strong>Payment:</strong> <span style="color:#16a34a; font-weight:600;"><%= header.PaymentMethod %></span></div>
        <% } %>
      </div>
    </section>

    <% if (header && header.PaymentMethod === 'Cash' && header.StatusDescription === 'Pending') { %>
      <section style="margin-top:16px; background:#fff3cd; border-left:4px solid #ffc107; padding:16px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
        <p style="margin:0; color:#856404; font-size:1.1rem; font-weight:500;">
          üíµ <strong>Thank you!</strong> Please proceed to the cashier to complete your payment.
        </p>
      </section>
    <% } %>

    <% if (header && (header.PaymentMethod === 'GCash' || header.PaymentMethod === 'Online') && header.StatusDescription === 'Pending') { %>
      <section style="margin-top:16px; background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
        <h3 style="margin-top:0; color:#7c4700; text-align:center;">
          <% if (header.PaymentMethod === 'GCash') { %>
            üí≥ GCash Payment
          <% } else { %>
            üí≥ Online Payment
          <% } %>
        </h3>
        
        <% if (typeof qrCodeDataUrl !== 'undefined' && qrCodeDataUrl) { %>
          <div style="text-align:center; margin:20px 0;">
            <img src="<%= qrCodeDataUrl %>" alt="Payment QR Code" style="max-width:300px; border:2px solid #e5e7eb; border-radius:8px; padding:8px; margin:0 auto;"/>
          </div>
        <% } %>
        
        <div style="margin-top:16px; padding:16px; background:#f9fafb; border-radius:8px;">
          <p style="margin:0 0 12px 0; color:#374151; font-size:1rem; font-weight:600;">Payment Instructions:</p>
          <ul style="margin:0; padding-left:24px; color:#4b5563; line-height:1.8;">
            <% if (header.PaymentMethod === 'GCash') { %>
              <li>Open your <strong>GCash app</strong></li>
              <li>Scan the QR code above</li>
              <li>Enter the amount: <strong style="color:#16a34a;">‚Ç±<%= (parseFloat(header.TotalAmount || 0)).toFixed(2) %></strong></li>
              <li>Add a note: <strong>Order #<%= header.OrderID || header.ID %></strong></li>
              <li>Complete the payment and wait for confirmation</li>
            <% } else { %>
              <li>Use your preferred <strong>online payment method</strong></li>
              <li>Scan the QR code above</li>
              <li>Enter the amount: <strong style="color:#16a34a;">‚Ç±<%= (parseFloat(header.TotalAmount || 0)).toFixed(2) %></strong></li>
              <li>Include reference: <strong>Order #<%= header.OrderID || header.ID %></strong></li>
              <li>Complete the payment and wait for confirmation</li>
            <% } %>
          </ul>
        </div>
        
        <div style="margin-top:16px; padding:12px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:4px;">
          <p style="margin:0; color:#92400e; font-size:0.95rem;">
            ‚è∞ <strong>Please complete your payment.</strong> Your order will be processed once payment is confirmed.
          </p>
        </div>
      </section>
    <% } %>

    <section style="margin-top:16px;">
      <table class="menu-table" style="width:100%;">
        <thead>
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Qty</th>
            <th>Price/Item</th>
            <th>Line Total</th>
          </tr>
        </thead>
        <tbody>
          <% (items||[]).forEach(function(it, idx){ %>
            <tr>
              <td><%= idx+1 %></td>
              <td>
                <div style="font-weight: 600; margin-bottom: 4px;">
                  <%= it.ProductName || ('#'+(it.ProductID||'')) %>
                  <% if (it.Size) { %>
                    <% 
                      // Calculate base size price by subtracting option prices from unit price
                      let baseSizePrice = parseFloat(it.UnitPrice || it.Price || 0) || 0;
                      if (it.options && it.options.length > 0) {
                        it.options.forEach(function(opt) {
                          baseSizePrice -= (parseFloat(opt.price) || 0);
                        });
                      }
                    %>
                    <span style="color: #666; font-weight: 500;"> - <%= it.Size %></span>
                    <% if (baseSizePrice > 0) { %>
                      <span style="color: #28a745; font-size: 0.85rem;">(‚Ç±<%= baseSizePrice.toFixed(2) %>)</span>
                    <% } %>
                  <% } %>
                </div>
                <% if (it.options && it.options.length > 0) { %>
                  <div style="margin-top: 8px; padding-left: 12px; border-left: 3px solid #d4a574;">
                    <% it.options.forEach(function(opt, optIdx) { %>
                      <div style="font-size: 0.9rem; color: #555; margin: 4px 0;">
                        <span style="font-weight: 600; color: #7c4700;"><%= opt.type %>:</span> 
                        <%= opt.name %>
                        <% if (opt.price > 0) { %>
                          <span style="color: #28a745; font-size: 0.85rem;">(+‚Ç±<%= opt.price.toFixed(2) %>)</span>
                        <% } %>
                      </div>
                    <% }); %>
                  </div>
                <% } %>
              </td>
              <td><%= it.Quantity || it.qty || 1 %></td>
              <td>‚Ç±<%= (parseFloat(it.UnitPrice||it.Price||0)||0).toFixed(2) %></td>
              <td>‚Ç±<%= (parseFloat(it.Subtotal||it.LineTotal||0)||0).toFixed(2) %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </section>

    <!-- Options are now displayed inline with each product above -->

    <div style="margin-top:16px; display:flex; gap:12px; flex-wrap:wrap;">
      <% if (header && (header.StatusDescription === 'Completed' || header.StatusDescription === 'Ready')) { %>
        <form action="/reorder/<%= header.OrderID %>" method="POST" style="margin:0;">
          <button type="submit" class="btn" style="background:#28a745; border-color:#28a745;">
            üîÑ Reorder
          </button>
        </form>
      <% } %>
      <a class="btn" href="/menu">Back to Menu</a>
      <a class="btn" href="/">Back to Homepage</a>
    </div>
  </main>
  
  <footer class="footer">
    <p>üìç <%= __('Alimond\'s Caf√© ‚Äì Every cup brewed with love, for the neighborhood we call home.') %></p>
    <p><%= __('Follow us @alimondscafe | Open daily 9am‚Äì7pm') %></p>
  </footer>

  <div style="margin: 20px; padding: 0 20px; display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" style="background: linear-gradient(135deg, #d4a574 0%, #c99860 100%); color: white; height: 48px; padding: 0 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease; display: inline-block; min-width: 150px; text-align: center; font-family: inherit; line-height: 48px;">üåô <%= __('Toggle Dark Mode') %></button>
    <a href="/menu" class="btn" style="background: linear-gradient(135deg, #d4a574 0%, #c99860 100%); color: white; height: 48px; padding: 0 24px; text-decoration: none; border-radius: 8px;margin-top: 0; font-size: 1rem; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease; display: inline-block; min-width: 150px; text-align: center; font-family: inherit; line-height: 48px;">
      <%= __('View Full Menu') %>
    </a>
  </div>

  <script>
    function toggleDarkMode() {
      var isDark = document.body.classList.toggle('dark-mode');
      try { localStorage.setItem('darkMode', isDark ? '1' : '0'); } catch(e) {}
    }
    
    // Restore saved dark mode preference
    (function() {
      try {
        var saved = localStorage.getItem('darkMode');
        if (saved === '1') document.body.classList.add('dark-mode');
      } catch(e) {}
    })();
  </script>
</body>
</html>
