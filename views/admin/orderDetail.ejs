<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order #<%= order.OrderID %> - Admin</title>
  <link rel="stylesheet" href="/menu.css">
  <link rel="stylesheet" href="/admin.css">
  <style>
    .status-form {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    .status-form select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 12px;
    }
    .status-form button {
      padding: 8px 20px;
      background: #7c4700;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .status-form button:hover {
      background: #5c3400;
    }
    .info-card {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    .info-row {
      display: flex;
      gap: 20px;
      margin: 8px 0;
    }
    .info-label {
      font-weight: 600;
      color: #555;
    }
  </style>
</head>
<body>
  <nav class="admin-nav">
    <div class="admin-nav-left">
      <strong class="admin-nav-title">Order Details</strong>
      <span class="admin-user-badge">üîê <%= adminUser.Username %></span>
    </div>
    <div class="admin-nav-right">
      <a href="/admin/dashboard" class="admin-nav-link">All Orders</a>
      <a href="/admin/queue" class="admin-nav-link">Order Queue</a>
      <a href="/admin/completed" class="admin-nav-link">Order History</a>
      <a href="/menu" class="admin-nav-link">Menu</a>
      <a href="/admin/order-settings" class="admin-nav-link">‚öôÔ∏è Settings</a>
      <a href="/logout" class="admin-logout-link">Logout</a>
    </div>
  </nav>

  <main style="max-width: 1000px; margin: 20px auto; padding: 0 20px;">
    <h1 style="color: #7c4700;">Order #<%= order.OrderID %></h1>
    
    <% if (typeof created !== 'undefined' && created) { %>
      <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <strong>‚úì Order created successfully!</strong><br>
        Order ID: <strong>#<%= order.OrderID %></strong><br>
        Payment Status: <strong><%= order.PaymentMethod ? 'Paid (' + order.PaymentMethod + ')' : 'Pending' %></strong><br>
        <% if (order.Notes && (order.Notes.includes('Change:') || order.Notes.includes('Amount Received:'))) { %>
          <span style="color: #155724;"><%= order.Notes.split('|').pop().trim() %></span><br>
        <% } %>
        This order is now available in the <a href="/admin/queue" style="color: #155724; text-decoration: underline; font-weight: bold;">Order Queue</a>.
      </div>
    <% } %>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div></div>
      <div style="display: flex; gap: 10px;">
        <button onclick="printReceipt()" class="btn" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          üñ®Ô∏è Print Receipt
        </button>
        <button onclick="emailReceipt()" class="btn" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          üìß Email Receipt
        </button>
      </div>
    </div>
    
    <div class="info-card">
      <div class="info-row">
        <div><span class="info-label">Customer:</span> <%= order.CustomerName || '-' %></div>
        <div><span class="info-label">Email:</span> <%= order.CustomerEmail || '-' %></div>
        <div><span class="info-label">Phone:</span> <%= order.CustomerPhone || '-' %></div>
      </div>
      <div class="info-row">
        <div><span class="info-label">Total:</span> ‚Ç±<%= parseFloat(order.TotalAmount || 0).toFixed(2) %></div>
        <div><span class="info-label">Payment:</span> <%= order.PaymentMethod || 'Pending' %></div>
        <div><span class="info-label">Date:</span> <%= new Date(order.CreatedAt).toLocaleString() %></div>
      </div>
      <div class="info-row">
        <div><span class="info-label">Current Status:</span> <strong><%= order.StatusName || 'Pending' %></strong></div>
      </div>
    </div>

    <% if (order.StatusID === 1 || !order.PaymentMethod || order.PaymentMethod === 'Pending') { %>
      <div class="status-form" style="background: #fff3cd; border: 2px solid #ffc107;">
        <h3 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Mark Order as Paid</h3>
        <p style="margin-bottom: 15px; color: #856404;">This order hasn't been confirmed as paid yet. <% if (order.PaymentMethod && order.PaymentMethod !== 'Pending') { %>Confirm payment was received.<% } else { %>Select payment method to mark as paid:<% } %></p>
        <form action="/admin/order/<%= order.OrderID %>/mark-paid" method="POST">
          <% if (!order.PaymentMethod || order.PaymentMethod === 'Pending') { %>
            <select name="paymentMethod" required style="margin-right: 12px;">
              <option value="">Select Payment Method</option>
              <option value="Cash">Cash</option>
              <option value="GCash">GCash</option>
              <option value="Card">Card</option>
              <option value="Online">Online Payment</option>
            </select>
          <% } else { %>
            <input type="hidden" name="paymentMethod" value="<%= order.PaymentMethod %>">
            <strong style="margin-right: 12px;">Payment Method: <%= order.PaymentMethod %></strong>
          <% } %>
          <button type="submit" style="background: #28a745; padding: 8px 20px; color: white; border: none; border-radius: 4px; cursor: pointer;">Confirm Payment Received</button>
        </form>
      </div>
    <% } else { %>
      <div class="status-form" style="background: #d4edda; border: 2px solid #28a745;">
        <h3 style="margin-top: 0; color: #155724;">‚úì Payment Confirmed</h3>
        <p style="margin: 0; color: #155724;">Payment Method: <strong><%= order.PaymentMethod %></strong></p>
      </div>
    <% } %>

    <% if (order.StatusID === 3) { %>
      <div class="status-form" style="background: #d1ecf1; border: 2px solid #0c5460;">
        <h3 style="margin-top: 0; color: #0c5460;">üî® Order is Being Prepared</h3>
        <p style="margin-bottom: 15px; color: #0c5460;">Click below when the order is ready for customer pickup:</p>
        <form action="/admin/order/<%= order.OrderID %>/status" method="POST">
          <input type="hidden" name="statusId" value="4">
          <input type="hidden" name="redirect" value="/admin/queue">
          <button type="submit" style="background: #28a745; padding: 10px 24px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 600;">‚úì Ready for Pickup</button>
        </form>
      </div>
    <% } %>

    <h3 style="margin-top: 30px;">Order Items</h3>
    <table class="menu-table" style="width: 100%;">
      <thead>
        <tr>
          <th>#</th>
          <th>Product</th>
          <th>Size</th>
          <th>Quantity</th>
          <th>Unit Price</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody>
        <% if (items && items.length > 0) { %>
          <% items.forEach(function(item, idx) { %>
            <tr>
              <td><%= idx + 1 %></td>
              <td><%= item.ProductName || 'Product #' + item.ProductID %></td>
              <td><%= item.Size || '-' %></td>
              <td><%= item.Quantity %></td>
              <td>‚Ç±<%= parseFloat(item.UnitPrice || 0).toFixed(2) %></td>
              <td>‚Ç±<%= parseFloat(item.Subtotal || 0).toFixed(2) %></td>
            </tr>
          <% }); %>
        <% } else { %>
          <tr>
            <td colspan="6" style="text-align: center; padding: 20px;">No items</td>
          </tr>
        <% } %>
      </tbody>
    </table>

    <% if (options && options.length > 0) { %>
      <h3 style="margin-top: 30px;">Order Options</h3>
      <table class="menu-table" style="width: 100%;">
        <thead>
          <tr>
            <th>Option Type</th>
            <th>Value</th>
            <th>Extra Price</th>
          </tr>
        </thead>
        <tbody>
          <% options.forEach(function(opt) { %>
            <tr>
              <td><%= opt.OptionName %></td>
              <td><%= opt.OptionValue %></td>
              <td>‚Ç±<%= parseFloat(opt.ExtraPrice || 0).toFixed(2) %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    <% } %>

    <div style="margin-top: 20px;">
      <a href="/admin/dashboard" class="btn">Back to Dashboard</a>
    </div>
  </main>
  
  <script>
    function printReceipt() {
      window.print();
    }
    
    function emailReceipt() {
      const orderId = <%= order.OrderID %>;
      const customerEmail = prompt('Enter customer email address:');
      
      if (!customerEmail) {
        return;
      }
      
      if (!customerEmail.includes('@')) {
        alert('Please enter a valid email address');
        return;
      }
      
      // Create form data
      const formData = new FormData();
      formData.append('orderId', orderId);
      formData.append('email', customerEmail);
      
      // Send email request
      fetch('/admin/order/' + orderId + '/send-receipt', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('‚úì Receipt sent successfully to ' + customerEmail);
        } else {
          alert('‚úó Failed to send receipt: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(error => {
        alert('‚úó Failed to send receipt. Please check your internet connection.');
        console.error('Email error:', error);
      });
    }
  </script>
  
  <style media="print">
    nav, .status-form, .btn, a[href="/admin/dashboard"] {
      display: none !important;
    }
    
    body {
      background: white;
    }
    
    main {
      max-width: 100% !important;
      margin: 0 !important;
      padding: 20px !important;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .info-card {
      box-shadow: none !important;
      border: 1px solid #ddd;
    }
    
    table {
      page-break-inside: auto;
    }
    
    tr {
      page-break-inside: avoid;
      page-break-after: auto;
    }
  </style>
  
  <button onclick="toggleDarkMode()" style="position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: #7c4700; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000;">üåô Toggle Dark Mode</button>

  <script>
    function toggleDarkMode() {
      var isDark = document.body.classList.toggle('dark-mode');
      try { localStorage.setItem('darkMode', isDark ? '1' : '0'); } catch(e) {}
    }
    
    // Restore saved dark mode preference
    (function() {
      try {
        var saved = localStorage.getItem('darkMode');
        if (saved === '1') document.body.classList.add('dark-mode');
      } catch(e) {}
    })();
  </script>
</body>
</html>

